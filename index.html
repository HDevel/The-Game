<!doctype html>
<html>
<head>
	<title>ACL test1</title>
	<!--<script type="text/javascript" src="http://code.jquery.com/jquery-2.0.0.min.js"></script>-->
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1,minimal-ui">
</head>
<body>
<div id="score">0</div>
<canvas id="canvas" width="320" height="430" style=""></canvas>
<script>
	var canvas = document.getElementById('canvas');
	var canvasctx = canvas.getContext("2d");

	var colorLib = [
			'#f00',
			'#0f0',
			'#00f',
			'#0ff'
	];
	var preRandomColor = new Array();
	var preRandomPos = new Array();
	colorLib.forEach(function (v, i) {
		preRandomColor[i] = v;
		preRandomPos[i] = i;
	});

	var objList = new Array();
	var cube = {
		width:50,
		height:50,
		color:'#000',
		x:0,
		y:0,
		accX:0,
		accY: 2,
		grav: new Object(),
		id:-1,
		magnetX:0,
		switched:false,
		score:100,
		power:5
	}
	var score = 0;
	var gravityPlace = new Object();

	function createCube(item){
		var newCube = Object.create(cube);

		var dropWidth = canvas.width / colorLib.length;
		var randPosX = preRandomPos[item];

		newCube.x = dropWidth * randPosX + (dropWidth / 2) - (newCube.width / 2);
		newCube.item = item;
		newCube.color = preRandomColor[newCube.item]
		newCube.id = objList.length;
		objList.push(newCube);
	}
	function shuffle(o){ //v1.0
		for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
		return o;
	};

	var curItem = 10000;

	setInterval(function () {
		for(var i = 0; i < 2; i++){
			randCube()
		}
	},4000);

	function randCube(){
		if(curItem >= colorLib.length){
			preRandomColor = shuffle(preRandomColor);
			preRandomPos = shuffle(preRandomPos);
			curItem = 0;
		}
		createCube(curItem);
		curItem++;
	};

	function render(){
		canvasctx.clearRect(0, 0, canvas.width, canvas.height);
		objList.forEach(function (v, i) {
			for(var g in gravityPlace){
				var grav = gravityPlace[g];
				if(v.y < grav[1] && grav[1] < v.y + v.height){
					if(v.x + v.width/2 < grav[0]){
						if(grav[2] == undefined){
							grav[2] = v;
						}
						if(grav[2].x < v.x){
							grav[2] = v;
						}
					} else {
						if(grav[3] == undefined){
							grav[3] = v;
						}
						if(grav[3].x > v.x){
							grav[3] = v;
						}
					}
				}
			}
		})
		for(var g in gravityPlace){
			var grav = gravityPlace[g];

			var aloneL = true;
			var aloneR = true;
			var switchL;
			var switchR;

			objList.forEach(function (v, i) {
				if(
					grav[2] &&
					v.x < grav[0] &&
					v.y == grav[2].y &&
					grav[2].x-2 < v.x + v.width &&
					grav[2].id != i
				){
					aloneL = false;
					switchL = v;
				}

				if(
					grav[3] &&
					v.x > grav[0] &&
					v.y == grav[3].y &&
					grav[3].x + grav[3].width > v.x-2 &&
					grav[3].id != i
				){
					aloneR = false;
					switchR = v;
				}
			});

			if(aloneL && grav[2]){
				grav[2].x -= grav[2].power;
			} else if(!aloneL && !grav[2].switched && !switchL.switched){
				var color = grav[2].color;
				grav[2].color = switchL.color
				switchL.color = color;
				grav[2].switched = true;
				switchL.switched = true;
			}
			if(aloneR && grav[3]){
				grav[3].x += grav[3].power;
			} else if(!aloneR && !grav[3].switched && !switchR.switched){
				var color = grav[3].color;
				grav[3].color = switchR.color
				switchR.color = color;
				grav[3].switched = true;
				switchR.switched = true;
			}

			delete grav[2];
			delete grav[3];
		}
		objList.forEach(function (v, i) {
			v.x += v.accX;
			v.y += v.accY;
			var mag = 0.5
			if(v.x < v.magnetX){
				v.x += mag
			} else {
				v.x -= mag
			}
			var posX = v.x + v.width/2;
			var dropSize = canvas.width / colorLib.length;
			var pos = Math.floor(posX / dropSize);
			if(colorLib[pos] == v.color && v.y > canvas.height - 20){
				if(v.score != 0){
					score += v.score;
					v.score = 0
				}
			}
			if(colorLib[pos] != v.color && v.y > canvas.height - 20){
				if(v.score != 0){
					score -= v.score;
					v.score = 0
				}
			}
			v.magnetX = (dropSize * pos) + (dropSize/2) - (v.width / 2);
			if(v.x < 0){
				v.x = 0;
			}
			if(v.x + v.width > canvas.width){
				v.x = canvas.width - v.width;
			}
			canvasctx.fillStyle = v.color;
			canvasctx.fillRect(v.x,v.y,v.width,v.height);
		});
	}

	function drawDrop(){
		for(var i = 0; i < colorLib.length; i++){
			canvasctx.fillStyle = colorLib[i];
			var w = canvas.width / colorLib.length;
			canvasctx.fillRect(w * i, canvas.height - 20,w,20);
		}
	}
	setInterval(function () {
		document.getElementById('score').innerHTML = score;
	},1000)

	setInterval(function () {
		render();
		drawDrop();
	},20);

	document.ontouchstart = function ontouchstart(e) {
		e.preventDefault();
		for(var t in e.changedTouches) {
			var touch = e.changedTouches[t]
			if(touch.identifier != undefined){
				gravityPlace[touch.identifier] = [touch.pageX, touch.pageY];
			}
		}
	}
	document.ontouchmove = function ontouchmove(e) {
		e.preventDefault();
		for(var t in e.changedTouches) {
			var touch = e.changedTouches[t]
			if(touch.identifier != undefined){
				gravityPlace[touch.identifier] = [touch.pageX, touch.pageY];
			}
		}
	}
	document.ontouchend = function ontouchend(e) {
		e.preventDefault();
		for(var t in e.changedTouches) {
			var touch = e.changedTouches[t]
			if(touch.identifier != undefined){
				delete gravityPlace[touch.identifier];
			}
		}
		objList.forEach(function (v, i) {
			v.switched = false;
		})
	}

</script>
</body>
</html>